<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Image Builder Blueprint Converter</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        textarea {
            width: 100%;
            height: 200px;
            font-family: 'Courier New', monospace;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            resize: vertical;
        }

        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }

        button:hover {
            background-color: #0056b3;
        }

        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }

        .error {
            color: red;
            background-color: #ffe6e6;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }

        .success {
            color: green;
            background-color: #e6ffe6;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }

        .section {
            margin: 20px 0;
        }

        h1,
        h2 {
            color: #333;
        }

        .loading {
            color: #666;
            font-style: italic;
        }

        .github-link {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: #333;
            color: white;
            padding: 10px 15px;
            text-decoration: none;
            border-radius: 4px;
        }

        .github-link:hover {
            background-color: #555;
        }
    </style>
</head>

<body>
    <a href="https://github.com/osbuild/blueprint-schema" class="github-link">View on GitHub</a>

    <div class="container">
        <h1>Image Builder Blueprint Converter</h1>

        <p>This tool converts YAML blueprint files to TOML or JSON format using WebAssembly. It runs entirely in your
            browser with no server-side processing required.</p>

        <div id="loading" class="loading">Loading WASM module...</div>
        <div id="success" class="success" style="display: none;">WASM module loaded successfully! You can now convert
            blueprints.</div>

        <div class="section">
            <h2>Input (YAML Blueprint)</h2>
            <textarea id="yamlInput" placeholder="Paste your YAML blueprint here..." disabled></textarea>
        </div>

        <div class="section">
            <button id="tomlBtn" onclick="convertToTOML()" disabled>Convert to TOML</button>
            <button id="jsonBtn" onclick="convertToJSON()" disabled>Convert to JSON</button>
            <button id="clearBtn" onclick="clearAll()" disabled>Clear</button>
        </div>

        <div id="error" class="error" style="display: none;"></div>

        <div class="section">
            <h2>Output</h2>
            <textarea id="output" readonly placeholder="Converted output will appear here..."></textarea>
        </div>

        <div class="section">
            <h2>About</h2>
            <p>This converter is part of the <a href="https://github.com/osbuild/blueprint-schema">blueprint-schema</a>
                project. It uses the same conversion logic as the command-line tool but runs entirely in your browser
                using WebAssembly.</p>

            <h3>Features:</h3>
            <ul>
                <li>Convert YAML blueprints to TOML format (legacy)</li>
                <li>Convert YAML blueprints to JSON format</li>
                <li>Client-side processing - no data sent to servers</li>
                <li>Same validation and conversion logic as the CLI tool</li>
            </ul>
        </div>
    </div>

    <script src="wasm_exec.js"></script>
    <script>
        let wasmReady = false;
        const go = new Go();
        WebAssembly.instantiateStreaming(fetch("blueprint.wasm"), go.importObject).then((result) => {
            go.run(result.instance);
            wasmReady = true;

            document.getElementById('loading').style.display = 'none';
            document.getElementById('success').style.display = 'block';

            document.getElementById('yamlInput').disabled = false;
            document.getElementById('tomlBtn').disabled = false;
            document.getElementById('jsonBtn').disabled = false;
            document.getElementById('clearBtn').disabled = false;

            console.log("WASM module loaded successfully");
        }).catch((err) => {
            console.error("Failed to load WASM module:", err);
            document.getElementById('loading').style.display = 'none';
            showError("Failed to load WASM module: " + err.message);
        });

        document.addEventListener('DOMContentLoaded', () => {
            const yamlInput = document.getElementById('yamlInput');
            fetch('https://raw.githubusercontent.com/osbuild/blueprint-schema/refs/heads/main/testdata/all-fields.in.yaml')
                .then(response => {
                    if (!response.ok) {
                        throw new Error("Failed to load example YAML");
                    }
                    return response.text();
                })
                .then(data => {
                    yamlInput.value = data;
                })
                .catch(err => {
                    console.error("Error loading example YAML:", err);
                    showError("Failed to load example YAML: " + err.message);
                });
        });

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function hideError() {
            document.getElementById('error').style.display = 'none';
        }

        function convertToTOML() {
            if (!wasmReady) {
                showError("WASM module not loaded yet. Please wait and try again.");
                return;
            }

            hideError();
            const yamlInput = document.getElementById('yamlInput').value;

            if (!yamlInput.trim()) {
                showError("Please enter some YAML input");
                return;
            }

            try {
                const result = exportTOML(yamlInput);
                if (result.error) {
                    showError(result.error);
                } else {
                    document.getElementById('output').value = result.toml;
                }
            } catch (err) {
                showError("Conversion failed: " + err.message);
            }
        }

        function convertToJSON() {
            if (!wasmReady) {
                showError("WASM module not loaded yet. Please wait and try again.");
                return;
            }

            hideError();
            const yamlInput = document.getElementById('yamlInput').value;

            if (!yamlInput.trim()) {
                showError("Please enter some YAML input");
                return;
            }

            try {
                const result = exportJSON(yamlInput);
                if (result.error) {
                    showError(result.error);
                } else {
                    document.getElementById('output').value = result.json;
                }
            } catch (err) {
                showError("Conversion failed: " + err.message);
            }
        }

        function clearAll() {
            document.getElementById('yamlInput').value = '';
            document.getElementById('output').value = '';
            hideError();
        }
    </script>
</body>

</html>
